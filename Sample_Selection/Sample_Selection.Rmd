---
title: "Sample Selection"
author: Szi Kay Leung
date: "`r Sys.Date()`"
output:
  rmdformats::material:
    self_contained: true
    thumbnails: true
    lightbox: true
    gallery: true
    highlight: tango
    code_folding: hide
    fig_caption: true
    cards: true



---
```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE,warning=FALSE) #,fig.width=14, fig.height= 7)


# libraries
suppressMessages(library("janitor")) # set row to column names
suppressMessages(library("dplyr")) 
suppressMessages(library("plyr")) # rename factors in columns
suppressMessages(library("DT")) 
suppressMessages(library("ggplot2")) 
suppressMessages(library("wesanderson")) # colours 

source("/gpfs/mrc0/projects/Research_Project-MRC148213/sl693/Scripts/ad_bdr/Rmarkdown_Input.R")
```
# Aim

**To choose BDR Samples for Targeted Iso-Seq by**    
- Braak-Stage, starting off first with 0 and 6  
- RINscore and concentration

## Input Files {.tabset .tabset-pills}

1. Phenotype Data from 96 samples - *Filename = 96_samples.csv*  
2. Phenotype Data from 133 samples - *Filename = 96_samples.csv*  
3. RIN values from RNA extracted by G.Wheildon - *Filename = BDR_96_RNA_QC_2020-09-02 - 11-33-54-RNA_sampleTable.csv*

```{r}
# Input files 
# 1. Phenotype_All information of core 96 samples 
# 2. RIN_All from RNA extracted by G.Wheildon of core 96 samples
# 3. Phenotype information for tab 133 samples
input_dir <- "/gpfs/mrc0/projects/Research_Project-MRC148213/sl693/AD_BDR/Samples/"
Phenotype_All <-read.csv(paste0(input_dir,"96_samples.csv"))[-1]
RIN_All <- read.table(paste0(input_dir,"BDR_96_RNA_QC_2020-09-02 - 11-33-54-RNA_sampleTable.csv"), as.is = T, sep = ",") %>% row_to_names(row_number = 1)
Phenotype_133_All <- read.csv(paste0(input_dir,"133_samples.csv"))[-1]

# Data Wrangle QC
# Gender, ensure F = Female, M = Male for all values
Phenotype_All$Gender <- revalue(Phenotype_All$Gender, c("F" = "female", "M" = "male"))
# Braak Stage
Phenotype_All$Braak.Stage_numeric <- lapply(Phenotype_All$Braak.Stage, function(x) 
  if(x == "Braak tangle stage I "){"1"
} else if (x == "Braak tangle stage II "){"2"
} else if (x == "Braak tangle stage III "){"3"
} else if (x == "Braak tangle stage IV "){"4"
} else if (x == "Braak tangle stage V "){"5"
})


```

### Phenotype: 96 Samples
```{r}
# Output Datatables 
datatable(Phenotype_All, caption = "Latest Phenotype data of 96 samples",options = list(pageLength = 5, scrollX = TRUE))
```

### Phenotype: 133 Samples
```{r}
datatable(Phenotype_133_All, caption = "Latest Phenotype data of 133 samples",options = list(pageLength = 5, scrollX = TRUE))
```

### Phenotype: RIN
```{r}
datatable(RIN_All, caption = "RIN Values from G.Wheildon",options = list(pageLength = 5, scrollX = TRUE))
```
## QC 
Checking to make sure data in columns (with similar names) in phenotype data match

#### Age
Columns: Age vs Age.y: `r all(Phenotype_All$Age == Phenotype_All$Age.y)`  
All the rows except for one sample (BBN_id: BBN002.30920) match in ages:   
- Age for sample = `r setdiff(Phenotype_All$Age,Phenotype_All$Age.x)`  
- Age.x for sample = `r setdiff(Phenotype_All$Age.x,Phenotype_All$Age)`  
Columns: Age.x vs Age.y: `r all(Phenotype_All$Age.x == Phenotype_All$Age.y)`  

#### Gender 
Columns: Gender vs Sex.x: `r all(Phenotype_All$Gender == Phenotype_All$Sex.x)`

#### Braak Stage
Columns: BraakTangle_numeric vs Braak_tangle: `r all(Phenotype_All$BraakTangle_numeric == Phenotype_All$Braak_tangle)`  
All the rows except for one sample (BBN_id: BBN_9944) match in Braak Stages:  
- BraakTangle_Numeric for sample = `r setdiff(Phenotype_All$BraakTangle_numeric,Phenotype_All$Braak_tangle)`  
- BraakTangle for sample = `r setdiff(Phenotype_All$Braak_tangle, Phenotype_All$BraakTangle_numeric)`  

# Merge samples by phenotype data and RIN

Samples in Phenotype data and RIN values are merged by Sample ID (concatenation of BBN.ID and Brain.ID).  
**Note: Discrepancy between sample ID, with some samples have no RIN values and others with no corresponding phenotypic data. Thus, 117 entries rather than 96 in Final Table. Some of the samples match with those in Phenotype file for 133 samples**

```{r}
# Simpify and Merge Phenotype and RIN dataframes
Phenotype <- Phenotype_All %>% mutate(ID = paste0(BBN.ID,";",Brain.ID)) %>% select(ID, Institute, BraakTangle_numeric, Age.x, Sex.x, Plate, APOE_geno, PMI)
Phenotype_133 <- Phenotype_133_All %>% mutate(ID = paste0(BBN.ID,";",Brain.ID)) %>% 
  select(ID, Institute, BraakTangle_numeric, Age.x, Sex.x, Plate, APOE_geno, PMI)
RIN <- RIN_All %>% mutate(ID = paste0(BBN.ID,";",Brain.ID)) %>% select(ID,RINe,conc)

# merge by ID (concatenation of BBN.ID and Brain.ID)
Final <- merge(Phenotype, RIN, by = "ID", all = T)
Final_133 <- merge(Phenotype_133, RIN, by = "ID", all = T)

# discrepancy between samples from phenotype and RIN values 
Final$QC <- apply(Final, 1, function(x) 
  if(!is.na(x[["Institute"]]) & !is.na(x[["RINe"]])){"Match"
  } else if (!is.na(x[["Institute"]]) & is.na(x[["RINe"]])){"No_RIN_value"
  } else if (is.na(x[["Institute"]]) & !is.na(x[["RINe"]])){"No_Phenotype_Data"})

Final %>% group_by(QC) %>% tally()

datatable(Final, caption = "Merged dataframe of phenotype data and RIN scores by Sample ID",options = list(pageLength = 5, scrollX = TRUE))
```

# All samples 

*Only taking those samples matching with phenotype data and RIN values* 

## Age and Braak Stages 

Good range of age across Braak Stages. Of note:  
- Only 5 samples in Braak Stage 0, with clear distinction between Sex and Age  
- Braak Stage 6 slightly older than Braak stage 0  
- Only `r nrow(Final %>% filter(QC == "Match" &BraakTangle_numeric == "6"))`, despite `r nrow(Final %>% filter(BraakTangle_numeric == "6"))` samples in core 96 phenotypic data  

```{r}
# age distribution
Final %>% filter(QC == "Match") %>% 
  ggplot(., aes(x = as.factor(BraakTangle_numeric), y = as.numeric(Age.x))) + geom_point(aes(colour = Sex.x)) + 
  theme_classic() + 
  labs(x = "Braak Stages", y = "Age") + 
  scale_colour_discrete(name = "Sex", labels = c("Female", "Male"))

```

## RIN and Braak Stages 

Similar range of RINs across Braak Stages. 
- Use all 5 samples for Braak Stage 0 moving forward for Iso-Seq 


```{r}
### RIN and Braakstages
Final %>% filter(QC == "Match") %>% 
  ggplot(., aes(x = as.factor(BraakTangle_numeric), y = as.numeric(RINe))) + geom_point(aes(colour = Sex.x)) + 
  theme_classic() + 
  labs(x = "Braak Stages", y = "RIN") + 
  scale_colour_discrete(name = "Sex", labels = c("Female", "Male"))
```

# Extreme Samples: Braak Stage 0 and 6

## RIN and Concentration
As expected, positive correlation of RIN to concentration for samples. Most samples with concentration > 100ng/uL (used in Mouse Targeted Iso-Seq prep)

```{r}
Final %>% filter(QC == "Match") %>% 
  filter(BraakTangle_numeric %in% c("0","6")) %>%
  ggplot(., aes(x = as.numeric(conc), y = as.numeric(RINe), colour = as.factor(BraakTangle_numeric), shape = Institute)) + geom_point(size = 3) +
  theme_classic() + 
  labs(y = "RIN", x = "Concentration (ng/uL)") + 
  scale_colour_manual(name = "Braak Stages", labels = c("0", "6"), values = c(wes_palette("Royal1")[1], wes_palette("Royal1")[2]))
```

## APOE genotype 
Mix of APOE genotype across Braak Stage 0 and 6. Note an "NA" value for one of the samples

```{r}
# APOE genotype
Final %>% filter(QC == "Match") %>% 
  filter(BraakTangle_numeric %in% c("0","6")) %>% 
  ggplot(., aes(x = APOE_geno, y = RINe,colour = as.factor(BraakTangle_numeric))) + geom_point(size = 3) + 
  theme_classic() + 
  labs(y = "RIN", x = "APOE Genotype") +
  scale_colour_manual(name = "Braak Stages", labels = c("0", "6"), values = c(wes_palette("Royal1")[1], wes_palette("Royal1")[2]))
```


